/* 0.1.3 обновление прошивки касс

cscript firmware.min.js <image> [<build>]

<image>		- путь к файлу с прошивкой.
<build>		- номер сборки прошивки в файле.

*/

(function(k,f){var c,g,n;f=!1;var b=0;var p=new ActiveXObject("Scripting.FileSystemObject");!b&&0<k.arguments.length&&(c=k.arguments(0))&&(g=p.getAbsolutePathName(c));!b&&1<k.arguments.length&&(c=k.arguments(1))&&(n=c);b||!g||p.fileExists(g)||(b=1);if(!b)try{var a=new ActiveXObject("Addin.DrvFR");var q=a.BaudRate;a.Password=30;a.GetECRStatus();a.ResultCode&&(b=2)}catch(r){b=2}!b&&n&&n==a.ECRBuild&&(b=3);b||4==a.ECRMode||(b=4);if(!b){var l={};for(var d=1;!a.ResultCode;d++){a.TableNumber=d;a.GetTableStruct();
l[d]={};var h=1;for(n=a.RowNumber;!a.ResultCode&&h<=n;h++){l[d][h]={};var m=1;for(p=a.FieldNumber;!a.ResultCode&&m<=p;m++)a.TableNumber=d,a.RowNumber=h,a.FieldNumber=m,a.GetFieldStruct(),a.ResultCode||(a.ReadTable(),a.ResultCode||a.FieldType&&1==a.MAXValueOfField||(c=a.FieldType?a.ValueOfFieldString:a.ValueOfFieldInteger,l[d][h][m]=c))}}93!=a.ResultCode&&(b=5)}if(!b&&!f)if(a.UpdateFirmwareMethod=1,a.FileName=g,a.UpdateFirmware(),a.ResultCode)b=6;else{for(;1==a.UpdateFirmwareStatus;)k.sleep(15E3);
a.UpdateFirmwareStatus||(f=!0)}if(!b&&!f)if(a.UpdateFirmwareMethod=0,a.FileName=g,a.UpdateFirmware(),a.ResultCode)b=7;else{for(;1==a.UpdateFirmwareStatus;)k.sleep(15E3);a.UpdateFirmwareStatus||(f=!0)}b||f||(a.TableNumber=14,a.RowNumber=1,a.FieldNumber=1,a.GetFieldStruct(),a.ResultCode?b=8:(a.ReadTable(),a.ResultCode?b=8:(c=a.FieldType?a.ValueOfFieldString:a.ValueOfFieldInteger,0!=c&&(b=8))));b||f||(c=0,a.TableNumber=23,a.RowNumber=1,a.FieldNumber=1,a.GetFieldStruct(),a.ResultCode?b=9:(a.FieldType?
a.ValueOfFieldString=c:a.ValueOfFieldInteger=c,a.WriteTable(),a.ResultCode&&(b=9)));b||f||(a.FileType=1,a.FileName=g,a.LoadFileOnSDCard(),a.ResultCode&&(b=10));b||f||(a.RebootKKT(),a.ResultCode&&(b=11));if(!b){a.Password=30;a.ConnectionTimeout=15E3;a.WaitConnection();d=0;for(g=5;a.ResultCode&&d<g;d++)a.WaitConnection(),k.sleep(15E3);d=0;for(g=7;a.ResultCode&&d<g;d++)a.BaudRate=d,a.WaitConnection();a.ResultCode&&(b=12)}b||f||(a.GetECRStatus(),a.ResultCode?b=13:(c=a.ECRMode,9!=c&&(b=13)));b||f||(a.ResetSettings(),
a.ResultCode&&(b=14));if(!b){var e=new Date;c=[9<e.getHours()?e.getHours():"0"+e.getHours(),9<e.getMinutes()?e.getMinutes():"0"+e.getMinutes(),9<e.getSeconds()?e.getSeconds():"0"+e.getSeconds()].join(":");a.Time=c;a.SetTime();a.ResultCode&&(b=15)}b||(c=[9<e.getDate()?e.getDate():"0"+e.getDate(),8<e.getMonth()?e.getMonth()+1:"0"+(e.getMonth()+1),e.getFullYear()].join("."),a.Date=c,a.SetDate(),a.ResultCode?b=16:(a.ConfirmDate(),a.ResultCode&&(b=16)));b||f||(a.InitTable(),a.ResultCode&&(b=17));if(!b)for(d in l)for(h in l[d])for(m in l[d][h])c=
l[d][h][m],a.TableNumber=d,a.RowNumber=h,a.FieldNumber=m,a.GetFieldStruct(),a.ResultCode||(a.FieldType?a.ValueOfFieldString=c:a.ValueOfFieldInteger=c,a.WriteTable());b||(a.GetExchangeParam(),a.ResultCode?b=18:(c=a.BaudRate,c!=q&&(a.BaudRate=q,a.SetExchangeParam(),a.ResultCode&&(b=18))));b||(a.RebootKKT(),a.ResultCode&&(b=19));k.quit(b)})(WSH);

/* 1.0.0 обновление прошивки касс

cscript firmware.min.js <image> [<build> [<model>]]

<image>     - Путь к файлу с прошивкой.
<build>     - Номер сборки прошивки в файле.
<model>     - Фильтр по названию модели кассы.

*/

(function(g,f){var c,m,n,p;f=!1;var b=0;var q=new ActiveXObject("Scripting.FileSystemObject");!b&&0<g.arguments.length&&(c=g.arguments(0))&&(m=q.getAbsolutePathName(c));!b&&1<g.arguments.length&&(c=g.arguments(1))&&(n=c);!b&&2<g.arguments.length&&(c=g.arguments(2))&&(p=c.toLowerCase());b||!m||q.fileExists(m)||(b=1);if(!b)try{var a=new ActiveXObject("Addin.DrvFR");var r=a.BaudRate;a.Password=30;a.GetECRStatus();a.ResultCode&&(b=2)}catch(t){b=2}!b&&n&&(c=a.ECRBuild,n==c&&(b=3));!b&&p&&(c=a.UDescription.toLowerCase(),
~c.indexOf(p)||(b=4));b||4==a.ECRMode||(b=5);if(!b){var k={};for(var d=1;!a.ResultCode;d++){a.TableNumber=d;a.GetTableStruct();k[d]={};var h=1;for(n=a.RowNumber;!a.ResultCode&&h<=n;h++){k[d][h]={};var l=1;for(p=a.FieldNumber;!a.ResultCode&&l<=p;l++)a.TableNumber=d,a.RowNumber=h,a.FieldNumber=l,a.GetFieldStruct(),a.ResultCode||(a.ReadTable(),a.ResultCode||a.FieldType&&1==a.MAXValueOfField||(c=a.FieldType?a.ValueOfFieldString:a.ValueOfFieldInteger,k[d][h][l]=c))}}93!=a.ResultCode&&(b=6)}if(!b&&!f&&
(a.UpdateFirmwareMethod=0,a.FileName=m,a.UpdateFirmware(),!a.ResultCode)){for(;1==a.UpdateFirmwareStatus;)g.sleep(15E3);a.UpdateFirmwareStatus||(f=!0)}if(!b&&!f){a.Password=30;a.ConnectionTimeout=15E3;a.WaitConnection();d=0;for(c=5;a.ResultCode&&d<c;d++)a.WaitConnection(),g.sleep(15E3);a.ResultCode&&(b=7)}if(!b&&!f)if(a.UpdateFirmwareMethod=1,a.FileName=m,a.UpdateFirmware(),a.ResultCode)b=8;else{for(;1==a.UpdateFirmwareStatus;)g.sleep(15E3);a.UpdateFirmwareStatus||(f=!0)}b||f||(a.TableNumber=14,a.RowNumber=
1,a.FieldNumber=1,a.GetFieldStruct(),a.ResultCode?b=9:(a.ReadTable(),a.ResultCode?b=9:(c=a.FieldType?a.ValueOfFieldString:a.ValueOfFieldInteger,0!=c&&(b=9))));b||f||(c=0,a.TableNumber=23,a.RowNumber=1,a.FieldNumber=1,a.GetFieldStruct(),a.ResultCode?b=10:(a.FieldType?a.ValueOfFieldString=c:a.ValueOfFieldInteger=c,a.WriteTable(),a.ResultCode&&(b=10)));b||f||(a.FileType=1,a.FileName=m,a.LoadFileOnSDCard(),a.ResultCode&&(b=11));b||f||(a.RebootKKT(),a.ResultCode&&(b=12));if(!b){a.Password=30;a.ConnectionTimeout=
15E3;a.WaitConnection();d=0;for(c=5;a.ResultCode&&d<c;d++)a.WaitConnection(),g.sleep(15E3);d=0;for(c=7;a.ResultCode&&d<c;d++)a.BaudRate=d,a.WaitConnection();a.ResultCode&&(b=13)}b||f||(a.GetECRStatus(),a.ResultCode?b=14:(c=a.ECRMode,9!=c&&(b=14)));b||f||(a.ResetSettings(),a.ResultCode&&(b=15));if(!b){var e=new Date;c=[9<e.getHours()?e.getHours():"0"+e.getHours(),9<e.getMinutes()?e.getMinutes():"0"+e.getMinutes(),9<e.getSeconds()?e.getSeconds():"0"+e.getSeconds()].join(":");a.Time=c;a.SetTime();a.ResultCode&&
(b=16)}b||(c=[9<e.getDate()?e.getDate():"0"+e.getDate(),8<e.getMonth()?e.getMonth()+1:"0"+(e.getMonth()+1),e.getFullYear()].join("."),a.Date=c,a.SetDate(),a.ResultCode?b=17:(a.ConfirmDate(),a.ResultCode&&(b=17)));b||f||(a.InitTable(),a.ResultCode&&(b=18));if(!b)for(d in k)for(h in k[d])for(l in k[d][h])c=k[d][h][l],a.TableNumber=d,a.RowNumber=h,a.FieldNumber=l,a.GetFieldStruct(),a.ResultCode||(a.FieldType?a.ValueOfFieldString=c:a.ValueOfFieldInteger=c,a.WriteTable());b||(a.GetExchangeParam(),a.ResultCode?
b=19:(c=a.BaudRate,c!=r&&(a.BaudRate=r,a.SetExchangeParam(),a.ResultCode&&(b=19))));b||(a.RebootKKT(),a.ResultCode&&(b=20));g.quit(b)})(WSH);
